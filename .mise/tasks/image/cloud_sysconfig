#!/usr/bin/env bash
# @describe Build the cloud image using sysconfig (with staged binaries)
# @arg reset[none|reset|full] Build reset mode. none (default) | reset (-r) | full (-x)
# @option --dataset The ZFS dataset root (defaults to env DATASET or rpool/images)
# @option --output-name The output image name (default: ttya-openindiana-hipster)
# @option --templates Template root directory (default: image/templates)
# @option --external-src Additional external source root (default: image/staging)
# @option --group Template group (default: cloudimage)
# @option --name Template name (default: ttya-openindiana-hipster)

set -euo pipefail

TASK_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
ROOT_DIR="${TASK_DIR}/../../.."
cd "$ROOT_DIR"

RESET="none"
DATASET_DEFAULT="${DATASET:-rpool/images}"
DATASET_ARG="$DATASET_DEFAULT"
TEMPLATES_DIR="image/templates"
EXTERNAL_SRC="image/staging"
GROUP="cloudimage"
NAME="ttya-openindiana-hipster"
OUTPUT_NAME="ttya-openindiana-hipster"

# Parse positional reset and named options following mise file task conventions
while [[ $# -gt 0 ]]; do
  case "$1" in
    none|reset|full)
      RESET="$1"; shift ;;
    --dataset)
      DATASET_ARG="$2"; shift 2 ;;
    --output-name)
      OUTPUT_NAME="$2"; shift 2 ;;
    --templates)
      TEMPLATES_DIR="$2"; shift 2 ;;
    --external-src)
      EXTERNAL_SRC="$2"; shift 2 ;;
    --group)
      GROUP="$2"; shift 2 ;;
    --name)
      NAME="$2"; shift 2 ;;
    *)
      echo "Unknown argument: $1" >&2; exit 2 ;;
  esac
done

ARGS=( build -d "$DATASET_ARG" -g "$GROUP" -n "$NAME" -T "$TEMPLATES_DIR" -N "$OUTPUT_NAME" -E "$EXTERNAL_SRC" )
case "$RESET" in
  reset) ARGS+=( -r ) ;;
  full)  ARGS+=( -x ) ;;
  none)  : ;;
  *) echo "Invalid reset: $RESET" >&2; exit 2 ;;
esac

# Resolve image-builder path reliably (pfexec may not inherit PATH)
resolve_image_builder() {
  if [[ -n "${IMAGE_BUILDER:-}" && -x "${IMAGE_BUILDER}" ]]; then
    echo "$IMAGE_BUILDER"; return 0;
  fi
  if command -v image-builder >/dev/null 2>&1; then
    command -v image-builder; return 0;
  fi
  if [[ -x "$HOME/.cargo/bin/image-builder" ]]; then
    echo "$HOME/.cargo/bin/image-builder"; return 0;
  fi
  # Repo-local debug/dev build (common during development)
  if [[ -x "$ROOT_DIR/image-builder/target/release/image-builder" ]]; then
    echo "$ROOT_DIR/image-builder/target/release/image-builder"; return 0;
  fi
  return 1
}

if ! BUILDER_BIN=$(resolve_image_builder); then
  echo "image-builder not found. Run: mise run image:setup" >&2
  exit 1
fi

# Run builder (needs pfexec for ZFS)
pfexec "$BUILDER_BIN" "${ARGS[@]}"
