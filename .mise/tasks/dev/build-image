#!/usr/bin/env bash
# Build the development cloud image (migrated from dev-build.sh)
# Usage:
#   mise run dev:build-image -- [options]
#
# Options:
#   -d, --dataset DATASET    ZFS dataset for image builder (required)
#   -o, --output-dir DIR     Output directory for images (optional)
#   --prepare-binaries-only  Only prepare development binaries, don't build image
#   -h, --help               Show this help message

set -o errexit
set -o pipefail
set -o nounset

# Resolve repo root
TASK_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
ROOT_DIR="${TASK_DIR}/../../.."
SCRIPT_DIR="$ROOT_DIR"
cd "$ROOT_DIR"

# Source common utilities
# shellcheck disable=SC1091
source "${SCRIPT_DIR}/lib/common.sh"

# Default values
DATASET=""
OUTPUT_DIR=""
PREPARE_BINARIES_ONLY=false

# Get dynamic target directories
IMAGE_BUILDER_TARGET_DIR=$(get_crate_target_dir "${SCRIPT_DIR}/image-builder")
IMAGE_BUILDER="${IMAGE_BUILDER_TARGET_DIR}/release/image-builder"

usage() {
  cat << EOF
Usage: mise run dev:build-image -- [options]

Build illumos installer development cloud image with sysconfig support.

This task builds sysconfig components and then creates a cloud image that:
1. Mounts a 9p filesystem from the host containing this repo
2. Runs sysconfig daemons as SMF services inside the VM
3. Allows testing modifications without rebuilding the image

Options:
  -d, --dataset DATASET       ZFS dataset for image builder (required)
  -o, --output-dir DIR        Output directory for images (optional)
  --prepare-binaries-only     Only prepare development binaries, don't build image
  -h, --help                  Show this help message

Examples:
  mise run dev:build-image -- -d rpool/images
  mise run dev:build-image -- -d tank/build -o /export/images
  mise run dev:build-image -- --prepare-binaries-only

Prerequisites:
- ZFS dataset must exist for image builder workspace
- OpenIndiana hipster tarball must be available (built with openindiana templates)
- Rust toolchain must be installed for building sysconfig
- image-builder binary must be built
EOF
}

# Parse args
while [[ $# -gt 0 ]]; do
  case $1 in
    -d|--dataset) DATASET="$2"; shift 2 ;;
    -o|--output-dir) OUTPUT_DIR="$2"; shift 2 ;;
    --prepare-binaries-only) PREPARE_BINARIES_ONLY=true; shift ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Error: Unknown option $1" >&2; usage; exit 1 ;;
  esac
done

# Validate required arguments
if [[ -z "$DATASET" && "$PREPARE_BINARIES_ONLY" == false ]]; then
  echo "Error: Dataset is required. Use -d or --dataset to specify." >&2
  usage
  exit 1
fi

# Check if dataset exists (only if we're going to build an image)
if [[ "$PREPARE_BINARIES_ONLY" == false ]] && ! zfs list "$DATASET" >/dev/null 2>&1; then
  echo "Error: ZFS dataset '$DATASET' does not exist"
  exit 1
fi

if [[ "$PREPARE_BINARIES_ONLY" == false ]]; then
  echo "=== Development Cloud Image Build ==="
  echo "Dataset: $DATASET"
  echo "Repo: $SCRIPT_DIR"
  echo ""
else
  echo "=== Preparing Development Binaries ==="
  echo "Repo: $SCRIPT_DIR"
  echo ""
fi

# Step 1: Build image-builder if it doesn't exist (skip in prepare-binaries-only mode)
if [[ "$PREPARE_BINARIES_ONLY" == false ]]; then
  echo "Step 1: Checking image-builder..."
  if [[ ! -f "$IMAGE_BUILDER" ]]; then
    echo "Building image-builder..."
    (cd "$SCRIPT_DIR/image-builder" && cargo build --release)
  else
    echo "✓ image-builder already exists"
  fi
fi

# Step 2: Build sysconfig components (skip in prepare-binaries-only mode)
if [[ "$PREPARE_BINARIES_ONLY" == false ]]; then
  echo ""
  echo "Step 2: Building sysconfig components..."
  echo "  Building sysconfig..." && (cd "$SCRIPT_DIR/sysconfig" && cargo build --release)
  echo "  Building sysconfig-plugins..." && (cd "$SCRIPT_DIR/sysconfig-plugins" && cargo build --release)
  echo "  Building sysconfig-provisioning..." && (cd "$SCRIPT_DIR/sysconfig-provisioning" && cargo build --release)
  echo "✓ All sysconfig components built"

  # Verify binaries
  SYSCONFIG_TARGET_DIR=$(get_crate_target_dir "${SCRIPT_DIR}/sysconfig")
  SYSCONFIG_BINARY="${SYSCONFIG_TARGET_DIR}/release/sysconfig"
  [[ -f "${SYSCONFIG_BINARY}" ]] || { echo "Error: Failed to build sysconfig at ${SYSCONFIG_BINARY}" >&2; exit 1; }

  PLUGINS_TARGET_DIR=$(get_crate_target_dir "${SCRIPT_DIR}/sysconfig-plugins")
  ILLUMOS_PLUGIN_BINARY="${PLUGINS_TARGET_DIR}/release/illumos-base-plugin"
  [[ -f "${ILLUMOS_PLUGIN_BINARY}" ]] || { echo "Error: Failed to build illumos-base-plugin at ${ILLUMOS_PLUGIN_BINARY}" >&2; exit 1; }

  PROVISIONING_TARGET_DIR=$(get_crate_target_dir "${SCRIPT_DIR}/sysconfig-provisioning")
  PROVISIONING_PLUGIN_BINARY="${PROVISIONING_TARGET_DIR}/release/provisioning-plugin"
  [[ -f "${PROVISIONING_PLUGIN_BINARY}" ]] || { echo "Error: Failed to build provisioning-plugin at ${PROVISIONING_PLUGIN_BINARY}" >&2; exit 1; }

  echo "✓ All required binaries verified"
fi

# Step 3: Check for OpenIndiana tarball (skip in prepare-binaries-only mode)
if [[ "$PREPARE_BINARIES_ONLY" == false ]]; then
  echo ""
  echo "Step 3: Checking for OpenIndiana hipster tarball..."
  TARBALL_NAME="hipster-03-archive.tar.gz"
  OUTPUT_PATH="${DATASET}/output"
  if ! ls "/$(zfs get -H -o value mountpoint $OUTPUT_PATH 2>/dev/null || echo "nonexistent")/${TARBALL_NAME}" 2>/dev/null; then
    echo "Warning: ${TARBALL_NAME} not found in dataset output."
    echo "You may need to build the OpenIndiana templates first:\n"
    echo "  $IMAGE_BUILDER build -d $DATASET -g openindiana -n hipster-01-strap"
    echo "  $IMAGE_BUILDER build -d $DATASET -g openindiana -n hipster-02-image"
    echo "  $IMAGE_BUILDER build -d $DATASET -g openindiana -n hipster-03-archive"
    echo "\nContinuing anyway - the image build will fail if the tarball is missing."
  fi
fi

# Step 4: Prepare development binaries
echo ""
echo "Step 4: Preparing development binaries..."
# Call the task directly to avoid relying on nested 'mise run'
"${SCRIPT_DIR}/.mise/tasks/dev/prepare-binaries"

# Exit here if we only want to prepare binaries
if [[ "$PREPARE_BINARIES_ONLY" == true ]]; then
  echo ""
  echo "=== Development Binaries Prepared ==="
  echo ""
  echo "Binaries are ready in $SCRIPT_DIR/dev-bin/"
  echo "These will be available to the VM at /repo/dev-bin/ when mounted via 9P"
  echo ""
  echo "To build the full development image, run:"
  echo "  mise run dev:build-image -- -d <DATASET>"
  exit 0
fi

# Step 5: Build the development cloud image
echo ""
echo "Step 5: Building development cloud image..."

MACHINED_IMAGE_DIR="$SCRIPT_DIR/machined/image"
cd "$MACHINED_IMAGE_DIR"

BUILD_ARGS=(
  "build"
  "-d" "$DATASET"
  "-g" "cloudimage"
  "-n" "ttya-openindiana-hipster-dev"
  "-T" "$MACHINED_IMAGE_DIR/templates"
  "-E" "$SCRIPT_DIR"
)

if [[ -n "$OUTPUT_DIR" ]]; then
  mkdir -p "$OUTPUT_DIR"
  BUILD_ARGS+=("-o" "$OUTPUT_DIR")
fi

echo "Running: $IMAGE_BUILDER ${BUILD_ARGS[*]}"
"$IMAGE_BUILDER" "${BUILD_ARGS[@]}"

cd "$SCRIPT_DIR"

echo ""
echo "=== Build Complete ==="
echo ""
echo "Development cloud image has been created with the following features:"
echo "- 9P filesystem support for mounting host directories"
echo "- sysconfig daemon installed as SMF service"
echo "- sysconfig-plugins (illumos-base-plugin) as separate SMF service"
echo "- sysconfig-provisioning oneshot CLI service"
echo "- Development configuration loading KDL from /repo"
echo ""
echo "To use the image:"
echo "1. Boot the image in bhyve or libvirt with 9p filesystem sharing"
echo "2. The VM will automatically mount the repo at /repo via 9p"
echo "3. All sysconfig components start with proper SMF dependencies"
echo "4. Configuration loaded from /repo/sysconfig-plugins/test-provisioning-config.kdl"
echo "5. Binaries loaded from /repo/dev-bin/ (prepare via: mise run dev:prepare-binaries)"
echo "6. Make changes to any component on the host"
echo "7. Rebuild: cd <component> && cargo build --release"
echo "8. Update binaries in VM: mise run dev:prepare-binaries (on host)"
echo "9. Restart services in VM: svcadm restart svc:/system/installer/sysconfig"
echo "10. Or restart plugins: svcadm restart svc:/system/sysconfig/illumos-base"
echo "11. Or restart provisioning: svcadm restart svc:/system/sysconfig-provisioning"
echo ""
echo "Example bhyve command with 9p support:"
echo "bhyve -c 2 -m 2048M -w -H \\""
echo "  -s 0,hostbridge \\""
echo "  -s 1,lpc \\""
echo "  -s 2,ahci-hd,/path/to/image.raw \\""
echo "  -s 3,virtio-9p,repo=/path/to/repo \\""
echo "  -l com1,stdio \\""
echo "  -l bootrom,/usr/share/bhyve/BHYVE_UEFI.fd \\""
echo "  vm-name"
echo ""
echo "SMF Services in the VM:"
echo "- svc:/system/dev-9p-mount (mounts /repo)"
echo "- svc:/system/installer/sysconfig (main daemon)"
echo "- svc:/system/sysconfig-illumos-base (base plugin)"
echo "- svc:/system/sysconfig-provisioning (oneshot provisioning CLI)"
