#!/usr/bin/env bash
# Run tests for all Rust crates in this repository
set -euo pipefail
SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
ROOT_DIR="${SCRIPT_DIR}/../../.."
cd "$ROOT_DIR"

CRATES=(
  image-builder
  imgdepot
  installadm
  installer-ui
  instcomd
  instcomd/migration
  machineconfig
  machined
  ociclient
  sysconfig
  sysconfig-cli
  sysconfig-config-schema
  sysconfig-plugins
  sysconfig-provisioning
)

for crate in "${CRATES[@]}"; do
  if [[ -f "$crate/Cargo.toml" ]]; then
    echo "==> Testing $crate"
    (cd "$crate" && cargo test --all-targets ${CARGO_PROFILE:-})
  else
    echo "-- Skipping $crate (no Cargo.toml)"
  fi
done
